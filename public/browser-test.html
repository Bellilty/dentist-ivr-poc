<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>ğŸ¦· Dentist IVR â€” Browser Test</title>
    <script src="https://sdk.twilio.com/js/voice/releases/2.7.3/twilio.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f8f8f8;
            padding: 20px;
        }
        
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #log {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-line;
        }
    </style>
</head>

<body>
    <h2>ğŸ¦· Dentist IVR â€” Browser Test</h2>
    <button id="callBtn" disabled>ğŸ“ Call IVR</button>
    <button id="hangupBtn" disabled>âŒ Hang Up</button>
    <div id="log"></div>

    <script>
        const logDiv = document.getElementById("log");
        const log = (msg) => {
            const t = new Date().toLocaleTimeString();
            logDiv.textContent += `[${t}] ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        let device, connection;

        // Diagnostics hooks
        window.onerror = function (msg, url, line, col, error) {
            log(`ğŸ window.onerror: ${msg} at ${url}:${line}:${col}`);
            if (error && error.stack) log(error.stack);
        };
        window.onunhandledrejection = function (e) {
            log(`ğŸ unhandledrejection: ${e.reason && e.reason.message ? e.reason.message : e.reason}`);
        };
        (function envLogs() {
            try {
                log(`ğŸŒ Location: ${location.href}`);
                log(`ğŸ”’ Protocol: ${location.protocol}`);
                log(`ğŸ§­ Referrer: ${document.referrer || "-"}`);
                log(`ğŸ§© UA: ${navigator.userAgent}`);
                if (navigator.connection) {
                    const nc = navigator.connection;
                    log(`ğŸ“¶ Net: type=${nc.effectiveType}, downlink=${nc.downlink}Mb, rtt=${nc.rtt}ms, saveData=${nc.saveData}`);
                }
            } catch (_) {}
        })();

        async function probeCdn(url) {
            try {
                const res = await fetch(url, { method: "GET", mode: "no-cors" });
                // With no-cors we can't read details, but we can still know it didn't throw
                log(`ğŸ” probe(no-cors) ${url} => ok (opaque)`);
            } catch (e1) {
                log(`ğŸ” probe(no-cors) ${url} => ERR: ${e1.message}`);
            }
            try {
                const res2 = await fetch(url, { method: "GET" });
                log(`ğŸ” probe(cors) ${url} => ${res2.status} ${res2.statusText}`);
                const hdrs = [];
                res2.headers.forEach((v, k) => hdrs.push(`${k}: ${v}`));
                if (hdrs.length) log(`ğŸ” headers:\n${hdrs.join("\n")}`);
            } catch (e2) {
                log(`ğŸ” probe(cors) ${url} => ERR: ${e2.message}`);
            }
        }

        function loadScript(url) {
            return new Promise((resolve) => {
                const s = document.createElement("script");
                s.src = url;
                s.async = true;
                s.crossOrigin = "anonymous";
                s.referrerPolicy = "no-referrer-when-downgrade";
                s.onload = () => resolve({ ok: true });
                s.onerror = (e) => {
                    log(`âŒ script onerror for ${url}`);
                    resolve({ ok: false, error: e });
                };
                document.head.appendChild(s);
            });
        }

        async function loadTwilioSdk() {
            const primary = "https://sdk.twilio.com/js/voice/releases/2.7.3/twilio.min.js";
            const fallback = "https://media.twiliocdn.com/sdk/js/voice/releases/2.7.3/twilio.min.js";
            const ready = () => (typeof Twilio !== "undefined" && Twilio.Device);
            if (ready()) return true;
            log(`â¬‡ï¸ loading SDK primary: ${primary}`);
            await probeCdn(primary);
            let r1 = await loadScript(primary);
            await new Promise(r => setTimeout(r, 200));
            if (ready()) return true;
            log(`âš ï¸ primary load result: ${r1.ok ? "ok" : "error"}`);
            if (!r1.ok) log(`â„¹ï¸ trying fallback: ${fallback}`);
            await probeCdn(fallback);
            let r2 = await loadScript(fallback);
            await new Promise(r => setTimeout(r, 200));
            if (ready()) return true;
            log(`âš ï¸ fallback load result: ${r2.ok ? "ok" : "error"}`);
            return false;
        }

        async function initTwilio() {
            try {
                const sdkOk = await loadTwilioSdk();
                if (!sdkOk || typeof Twilio === "undefined" || !Twilio.Device) {
                    log("âŒ SDK failed to load from both CDNs. Check network/adblock.");
                    return;
                }
                log("ğŸ”— Fetching Twilio access token...");
                const res = await fetch("/api/token");
                const {
                    token
                } = await res.json();
                if (!token) throw new Error("No token returned from /api/token");

                log("âœ… Token received. Initializing Twilio Device v2...");
                device = new Twilio.Device(token, {
                    codecPreferences: ["opus", "pcmu"],
                    fakeLocalDTMF: true,
                    enableRingingState: true,
                });

                device.on("registered", () => {
                    log("ğŸ§ Device registered â€” you can now call the IVR.");
                    document.getElementById("callBtn").disabled = false;
                });

                device.on("unregistered", () => {
                    log("â„¹ï¸ Device unregistered.");
                    document.getElementById("callBtn").disabled = true;
                });

                device.on("error", (err) => log(`âš ï¸ Device error: ${err.message}`));
                device.on("disconnect", () => {
                    log("ğŸ“´ Call disconnected.");
                    document.getElementById("hangupBtn").disabled = true;
                    document.getElementById("callBtn").disabled = false;
                });

                device.register();
            } catch (err) {
                log("âŒ Initialization error: " + err.message);
            }
        }

        document.getElementById("callBtn").onclick = () => {
            if (!device) return log("âš ï¸ Device not ready yet!");
            log("ğŸ“ Connecting to Dentist IVR...");
            if (!device) return log("âš ï¸ Device not ready yet!");
            connection = device.connect();
            document.getElementById("callBtn").disabled = true;
            document.getElementById("hangupBtn").disabled = false;

            connection.on("accept", () => log("âœ… Call connected â€” speak freely."));
            connection.on("error", (err) => log("âŒ Call error: " + err.message));
            connection.on("disconnect", () => log("ğŸ“´ Call ended."));
        };

        document.getElementById("hangupBtn").onclick = () => {
            if (connection) connection.disconnect();
            log("ğŸ›‘ Hangup requested by user.");
            document.getElementById("hangupBtn").disabled = true;
            document.getElementById("callBtn").disabled = false;
        };

        // init Twilio as soon as page loads
        initTwilio();
    </script>
</body>

</html>