<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>ğŸ¦· Dentist IVR â€” Browser Test</title>
    <script src="https://media.twiliocdn.com/sdk/js/voice/releases/2.8.0/twilio.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f8f8f8;
            padding: 20px;
        }

        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #log {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-line;
        }
    </style>
</head>

<body>
    <h2>ğŸ¦· Dentist IVR â€” Browser Test</h2>
    <button id="callBtn" disabled>ğŸ“ Call IVR</button>
    <button id="hangupBtn" disabled>âŒ Hang Up</button>
    <div id="log"></div>

    <script>
        const logDiv = document.getElementById("log");
        const log = (msg) => {
            const t = new Date().toLocaleTimeString();
            logDiv.textContent += `[${t}] ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        let device, connection;

        async function initTwilio() {
            try {
                log("ğŸ”— Fetching Twilio access token...");
                const res = await fetch("/api/token");
                const { token } = await res.json();
                if (!token) throw new Error("No token returned from /api/token");

                log("âœ… Token received. Initializing Twilio Device v2...");
                device = new Twilio.Device(token, {
                    codecPreferences: ["opus", "pcmu"],
                    fakeLocalDTMF: true,
                    enableRingingState: true,
                });

                device.on("registered", () => {
                    log("ğŸ§ Device registered â€” you can now call the IVR.");
                    document.getElementById("callBtn").disabled = false;
                });

                device.on("unregistered", () => {
                    log("â„¹ï¸ Device unregistered.");
                    document.getElementById("callBtn").disabled = true;
                });

                device.on("error", (err) => log(`âš ï¸ Device error: ${err.message}`));
                device.on("disconnect", () => {
                    log("ğŸ“´ Call disconnected.");
                    document.getElementById("hangupBtn").disabled = true;
                    document.getElementById("callBtn").disabled = false;
                });

                device.register();
            } catch (err) {
                log("âŒ Initialization error: " + err.message);
            }
        }

        document.getElementById("callBtn").onclick = () => {
            if (!device) return log("âš ï¸ Device not ready yet!");
            log("ğŸ“ Connecting to Dentist IVR...");
            if (!device) return log("âš ï¸ Device not ready yet!");
            connection = device.connect();
            document.getElementById("callBtn").disabled = true;
            document.getElementById("hangupBtn").disabled = false;

            connection.on("accept", () => log("âœ… Call connected â€” speak freely."));
            connection.on("error", (err) => log("âŒ Call error: " + err.message));
            connection.on("disconnect", () => log("ğŸ“´ Call ended."));
        };

        document.getElementById("hangupBtn").onclick = () => {
            if (connection) connection.disconnect();
            log("ğŸ›‘ Hangup requested by user.");
            document.getElementById("hangupBtn").disabled = true;
            document.getElementById("callBtn").disabled = false;
        };

        // init Twilio as soon as page loads
        initTwilio();
    </script>
</body>

</html>