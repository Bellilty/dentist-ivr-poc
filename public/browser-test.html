<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ğŸ¦· Dentist IVR â€” Browser Test</title>
    <script src="https://media.twiliocdn.com/sdk/js/client/v1.13/twilio.min.js"></script>
    <style>
        body {
            font-family: Arial;
            background: #fafafa;
            padding: 20px;
        }

        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
        }

        #log {
            white-space: pre-line;
            background: #fff;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h2>ğŸ¦· Dentist IVR â€” Browser Test</h2>
    <button id="callBtn">ğŸ“ Call IVR</button>
    <button id="hangupBtn" disabled>âŒ Hang Up</button>
    <div id="log"></div>

    <script>
        const logDiv = document.getElementById("log");
        const log = (msg) => { logDiv.textContent += msg + "\n"; logDiv.scrollTop = logDiv.scrollHeight; };

        let device, connection;

        async function init() {
            log("ğŸ”— Requesting access token...");
            const res = await fetch("/api/token");
            const { token } = await res.json();
            log("âœ… Token received, initializing Twilio Device...");

            device = new Twilio.Device(token, { codecPreferences: ["opus", "pcmu"], fakeLocalDTMF: true });

            device.on("ready", () => log("ğŸ§ Device ready. Click 'Call IVR' to connect."));
            device.on("error", (err) => log("âš ï¸ Device error: " + err.message));
            device.on("disconnect", () => {
                log("ğŸ“´ Call ended.");
                document.getElementById("hangupBtn").disabled = true;
                document.getElementById("callBtn").disabled = false;
            });
        }

        document.getElementById("callBtn").onclick = async () => {
            if (!device) return log("âš ï¸ Device not ready yet!");
            log("ğŸ“ Connecting to IVR...");
            connection = device.connect();
            document.getElementById("hangupBtn").disabled = false;
            document.getElementById("callBtn").disabled = true;

            connection.on("accept", () => log("âœ… Call connected. Speak now..."));
            connection.on("error", (err) => log("âŒ Call error: " + err.message));
        };

        document.getElementById("hangupBtn").onclick = () => {
            if (connection) connection.disconnect();
            log("ğŸ›‘ Call manually hung up.");
            document.getElementById("hangupBtn").disabled = true;
            document.getElementById("callBtn").disabled = false;
        };

        init();
    </script>
</body>

</html>