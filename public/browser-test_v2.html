<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>ü¶∑ Dentist IVR V2 ‚Äî Browser Test (Alternative STT)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f8ff;
            padding: 20px;
        }
        
        .v2-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .v2-banner h2 {
            margin: 0 0 10px 0;
        }
        
        .v2-banner p {
            margin: 5px 0;
            font-size: 14px;
            opacity: 0.95;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .warning-box strong {
            color: #856404;
        }
        
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            background: #667eea;
            color: white;
            transition: background 0.3s;
        }
        
        button:hover:not(:disabled) {
            background: #5568d3;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #log {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-line;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="v2-banner">
        <h2>ü¶∑ Dentist IVR V2 ‚Äî Browser Test</h2>
        <p>Version de test avec transcription alternative (Google Cloud STT + Whisper fallback)</p>
    </div>
    
    <div class="warning-box">
        <strong>‚ö†Ô∏è Important :</strong> Pour tester cette version, vous devez configurer votre num√©ro Twilio dans la console Twilio pour pointer vers <code>https://dentist-ivr-poc.vercel.app/api/voice_v2</code> au lieu de <code>/api/voice</code>
    </div>
    
    <button id="callBtn" disabled>üìû Call +19296282092 (V2)</button>
    <button id="hangupBtn" disabled>‚ùå Hang Up</button>
    <div id="log"></div>

    <script>
        const logDiv = document.getElementById("log");
        const log = (msg) => {
            const t = new Date().toLocaleTimeString();
            logDiv.textContent += `[${t}] [V2] ${msg}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        let device, call;

        // Diagnostics hooks
        window.onerror = function(msg, url, line, col, error) {
            log(`üêû window.onerror: ${msg} at ${url}:${line}:${col}`);
            if (error && error.stack) log(error.stack);
        };
        window.onunhandledrejection = function(e) {
            log(`üêû unhandledrejection: ${e.reason && e.reason.message ? e.reason.message : e.reason}`);
        };
        (function envLogs() {
            try {
                log(`üåê Location: ${location.href}`);
                log(`üîí Protocol: ${location.protocol}`);
                log(`üß≠ Referrer: ${document.referrer || "-"}`);
                log(`üß© UA: ${navigator.userAgent}`);
                log(`üìå Testing V2 endpoint: /api/voice_v2`);
                if (navigator.connection) {
                    const nc = navigator.connection;
                    log(`üì∂ Net: type=${nc.effectiveType}, downlink=${nc.downlink}Mb, rtt=${nc.rtt}ms, saveData=${nc.saveData}`);
                }
            } catch (_) {}
        })();

        async function probeCdn(url) {
            try {
                const res = await fetch(url, {
                    method: "GET",
                    mode: "no-cors"
                });
                log(`üîé probe(no-cors) ${url} => ok (opaque)`);
            } catch (e1) {
                log(`üîé probe(no-cors) ${url} => ERR: ${e1.message}`);
            }
            try {
                const res2 = await fetch(url, {
                    method: "GET"
                });
                log(`üîé probe(cors) ${url} => ${res2.status} ${res2.statusText}`);
                const hdrs = [];
                res2.headers.forEach((v, k) => hdrs.push(`${k}: ${v}`));
                if (hdrs.length) log(`üîé headers:\n${hdrs.join("\n")}`);
            } catch (e2) {
                log(`üîé probe(cors) ${url} => ERR: ${e2.message}`);
            }
        }

        function loadScript(url, opts = {}) {
            return new Promise((resolve) => {
                const s = document.createElement("script");
                s.src = url;
                s.async = true;
                if (opts.crossOrigin !== false) s.crossOrigin = "anonymous";
                if (opts.referrerPolicy) s.referrerPolicy = opts.referrerPolicy;
                s.onload = () => resolve({
                    ok: true
                });
                s.onerror = (e) => {
                    log(`‚ùå script onerror for ${url}`);
                    resolve({
                        ok: false,
                        error: e
                    });
                };
                document.head.appendChild(s);
            });
        }

        async function loadTwilioSdk() {
            const sources = [{
                label: "primary",
                url: "https://sdk.twilio.com/js/voice/releases/2.7.3/twilio.min.js"
            }, {
                label: "cdn-fallback",
                url: "https://media.twiliocdn.com/sdk/js/voice/releases/2.7.3/twilio.min.js"
            }, {
                label: "local",
                url: "/vendor/twilio-voice-sdk-2.7.3.min.js",
                local: true
            }];
            const ready = () => (typeof Twilio !== "undefined" && Twilio.Device);
            if (ready()) return true;

            for (const src of sources) {
                log(`‚¨áÔ∏è loading SDK (${src.label}): ${src.url}`);
                if (src.local) {
                    try {
                        const res = await fetch(src.url, {
                            method: "GET"
                        });
                        log(`üîé probe(local) ${src.url} => ${res.status} ${res.statusText}`);
                    } catch (e) {
                        log(`üîé probe(local) ${src.url} => ERR: ${e.message}`);
                    }
                } else {
                    await probeCdn(src.url);
                }

                const result = await loadScript(src.url, {
                    crossOrigin: src.local ? false : "anonymous"
                });
                await new Promise((r) => setTimeout(r, 300));

                if (ready()) {
                    log(`‚úÖ SDK loaded from ${src.label}`);
                    return true;
                }

                log(`‚ö†Ô∏è ${src.label} load result: ${result.ok ? "ok" : "error"}`);
            }

            return ready();
        }

        async function initTwilio() {
            try {
                const sdkOk = await loadTwilioSdk();
                if (!sdkOk || typeof Twilio === "undefined" || !Twilio.Device) {
                    log("‚ùå SDK failed to load from both CDNs. Check network/adblock.");
                    return;
                }
                log("üîó Fetching Twilio access token...");
                const res = await fetch("/api/token");
                const {
                    token
                } = await res.json();
                if (!token) throw new Error("No token returned from /api/token");

                log("‚úÖ Token received. Initializing Twilio Device v2...");
                log("üìå Remember: Twilio webhook must point to /api/voice_v2");
                device = new Twilio.Device(token, {
                    codecPreferences: ["opus", "pcmu"],
                    fakeLocalDTMF: true,
                    enableRingingState: true,
                });

                device.on("registered", () => {
                    log("üéß Device registered ‚Äî you can now call the IVR V2.");
                    document.getElementById("callBtn").disabled = false;
                });

                device.on("unregistered", () => {
                    log("‚ÑπÔ∏è Device unregistered.");
                    document.getElementById("callBtn").disabled = true;
                });

                device.on("error", (err) => log(`‚ö†Ô∏è Device error: ${err.message}`));
                device.on("disconnect", () => {
                    log("üì¥ Call disconnected.");
                    document.getElementById("hangupBtn").disabled = true;
                    document.getElementById("callBtn").disabled = false;
                });

                device.register();
            } catch (err) {
                log("‚ùå Initialization error: " + err.message);
            }
        }

        // Simple DTMF keypad UI
        const keypad = document.createElement("div");
        keypad.style.marginTop = "10px";
        keypad.style.display = "grid";
        keypad.style.gridTemplateColumns = "repeat(3, 60px)";
        keypad.style.gap = "8px";
        const keys = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "*", "0", "#"];
        keys.forEach(k => {
            const b = document.createElement("button");
            b.textContent = k;
            b.onclick = () => {
                if (!call) return log("‚ö†Ô∏è No active call to send DTMF.");
                try {
                    call.sendDigits(k);
                    log(`üìü DTMF sent: ${k}`);
                } catch (e) {
                    log(`‚ùå DTMF error: ${e.message}`);
                }
            };
            keypad.appendChild(b);
        });
        document.body.insertBefore(keypad, document.getElementById("log"));

        document.getElementById("callBtn").onclick = async() => {
            try {
                if (!device) return log("‚ö†Ô∏è Device not ready yet!");
                log("üìû Connecting to Dentist IVR V2...");
                log("üîç Testing alternative STT (Google Cloud + Whisper fallback)");
                call = await device.connect();
                document.getElementById("callBtn").disabled = true;
                document.getElementById("hangupBtn").disabled = false;
                call.on("accept", () => log("‚úÖ Call connected ‚Äî speak freely (V2 mode)."));
                call.on("error", (err) => log("‚ùå Call error: " + err.message));
                call.on("disconnect", () => log("üì¥ Call ended."));
            } catch (e) {
                log("‚ùå Connect error: " + e.message);
            }
        };

        document.getElementById("hangupBtn").onclick = () => {
            if (call) call.disconnect();
            log("üõë Hangup requested by user.");
            document.getElementById("hangupBtn").disabled = true;
            document.getElementById("callBtn").disabled = false;
        };

        // init Twilio as soon as page loads
        initTwilio();
    </script>
</body>

</html>

